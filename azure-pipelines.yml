stages:
- stage: BuildAndTest
  jobs:
  - job: QualityGate
    steps:
    - script: pip install -r requirements.txt
      displayName: 'Install Dependencies'

    # This is the money shot.
    # If this script fails, the pipeline stops.
    # No deployment happens. Bad code is rejected.
    - script: python quality_gate.py
      displayName: 'Run Quality Gate'

- stage: Deploy
  dependsOn: BuildAndTest
  condition: succeeded()
  jobs:
  - job: TerraformApply
    steps:
      # ... your terraform apply steps here ...
